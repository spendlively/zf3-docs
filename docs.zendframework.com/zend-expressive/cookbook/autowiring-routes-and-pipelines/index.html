<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="zend-expressive: PSR-7 Middleware Microframework">  
    <link rel="shortcut icon" href="../../img/favicon.ico">

    <title>Autowiring routes and pipeline middleware - Expressive</title>

    <link rel="stylesheet" href="//cdn.jsdelivr.net/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha256-7s5uDGW3AHqw6xtJmNNtr+OBRJUlgkNJEo78P4b0yRw=" crossorigin="anonymous">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/fontawesome/4.6.3/css/font-awesome.min.css" integrity="sha256-AIodEDkC8V/bHBkfyxzolUMw57jeQ9CauwhVW6YJ9CA=" crossorigin="anonymous">
    <link rel="stylesheet" href="../../css/styles-482aa2add1.css">
        <link href="../../css/zend-expressive.css" rel="stylesheet">

    
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <span class="navbar-brand">
              <a class="logo-link" href="http://framework.zend.com" data-toggle="tooltip" data-placement="bottom" title="Zend Framework"><img src="../../img/zf-logo-mark.svg" height="28" alt="Zend Framework" /></a>
              <a href="../..">Expressive</a>
            </span>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../..">Home</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Getting Started <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../getting-started/features/">Overview and Features</a>
</li>

                        
                            
<li >
    <a href="../../getting-started/standalone/">Quick Start: Standalone</a>
</li>

                        
                            
<li >
    <a href="../../getting-started/skeleton/">Quick Start: Skeleton Installer</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Features <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../features/middleware-types/">Middleware Types</a>
</li>

                        
                            
<li >
    <a href="../../features/application/">Applications</a>
</li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Containers</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../features/container/intro/">Introduction</a>
</li>

        
            
<li >
    <a href="../../features/container/factories/">Container Factories</a>
</li>

        
            
<li >
    <a href="../../features/container/delegator-factories/">Delegator Factories</a>
</li>

        
            
<li >
    <a href="../../features/container/zend-servicemanager/">Using zend-servicemanager</a>
</li>

        
            
<li >
    <a href="../../features/container/pimple/">Using Pimple</a>
</li>

        
            
<li >
    <a href="../../features/container/aura-di/">Using Aura.Di</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Routing Adapters</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../features/router/intro/">Introduction</a>
</li>

        
            
<li >
    <a href="../../features/router/interface/">Routing Interface</a>
</li>

        
            
<li >
    <a href="../../features/router/uri-generation/">URI Generation</a>
</li>

        
            
<li >
    <a href="../../features/router/piping/">Routing vs Piping</a>
</li>

        
            
<li >
    <a href="../../features/router/aura/">Using Aura</a>
</li>

        
            
<li >
    <a href="../../features/router/fast-route/">Using FastRoute</a>
</li>

        
            
<li >
    <a href="../../features/router/zf2/">Using the ZF2 Router</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Templating</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../features/template/intro/">Introduction</a>
</li>

        
            
<li >
    <a href="../../features/template/interface/">Template Renderer Interface</a>
</li>

        
            
<li >
    <a href="../../features/template/middleware/">Templated Middleware</a>
</li>

        
            
<li >
    <a href="../../features/template/plates/">Using Plates</a>
</li>

        
            
<li >
    <a href="../../features/template/twig/">Using Twig</a>
</li>

        
            
<li >
    <a href="../../features/template/zend-view/">Using zend-view</a>
</li>

        
    </ul>
  </li>

                        
                            
<li >
    <a href="../../features/error-handling/">Error Handling</a>
</li>

                        
                            
<li >
    <a href="../../features/modular-applications/">Modular Applications</a>
</li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Middleware</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../features/middleware/implicit-methods-middleware/">Implicit HEAD and OPTIONS Middleware</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Helpers</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../features/helpers/intro/">Introduction</a>
</li>

        
            
<li >
    <a href="../../features/helpers/url-helper/">UrlHelper</a>
</li>

        
            
<li >
    <a href="../../features/helpers/server-url-helper/">ServerUrlHelper</a>
</li>

        
            
<li >
    <a href="../../features/helpers/body-parse/">Body Parsing Middleware</a>
</li>

        
            
<li >
    <a href="../../features/helpers/content-length/">Content-Length Middleware</a>
</li>

        
    </ul>
  </li>

                        
                            
<li >
    <a href="../../features/emitters/">Emitters</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Cookbook <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li class="active">
    <a href="./">Autowiring routes and pipeline middleware</a>
</li>

                        
                            
<li >
    <a href="../common-prefix-for-routes/">Prepending a common path to all routes</a>
</li>

                        
                            
<li >
    <a href="../route-specific-pipeline/">Route-specific middleware pipelines</a>
</li>

                        
                            
<li >
    <a href="../custom-404-page-handling/">Setting custom 404 page handling</a>
</li>

                        
                            
<li >
    <a href="../using-custom-view-helpers/">Registering custom view helpers when using zend-view</a>
</li>

                        
                            
<li >
    <a href="../using-zend-form-view-helpers/">Using zend-form view helpers</a>
</li>

                        
                            
<li >
    <a href="../using-a-base-path/">Using Expressive from a subdirectory</a>
</li>

                        
                            
<li >
    <a href="../modular-layout/">Building modular applications</a>
</li>

                        
                            
<li >
    <a href="../setting-locale-depending-routing-parameter/">Setting a locale based on a routing parameter</a>
</li>

                        
                            
<li >
    <a href="../setting-locale-without-routing-parameter/">Setting a locale without a routing parameter</a>
</li>

                        
                            
<li >
    <a href="../debug-toolbars/">Enabling debug toolbars</a>
</li>

                        
                            
<li >
    <a href="../using-routed-middleware-class-as-controller/">Handling multiple routes in a single class</a>
</li>

                        
                            
<li >
    <a href="../flash-messengers/">Flash Messengers</a>
</li>

                        
                            
<li >
    <a href="../passing-data-between-middleware/">Passing data between middleware</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../why-expressive/">Why choose Expressive?</a>
</li>

                        
                            
<li >
    <a href="../../reference/cli-tooling/">CLI Tooling</a>
</li>

                        
                            
<li >
    <a href="../../reference/usage-examples/">Examples</a>
</li>

                        
                            
<li >
    <a href="../../reference/expressive-projects/">Expressive Projects</a>
</li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Migration</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../reference/migration/rc-to-v1/">From RC5 and Earlier</a>
</li>

        
            
<li >
    <a href="../../reference/migration/to-v1-1/">To Expressive 1.1</a>
</li>

        
            
<li >
    <a href="../../reference/migration/to-v2/">To Expressive 2.0</a>
</li>

        
    </ul>
  </li>

                        
                        </ul>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" class="component-toggle" data-toggle="tooltip" data-placement="bottom" title="Show component list">
                        <i class="fa fa-book"></i> Components
                    </a>
                </li>

                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li>
                        <a href="https://github.com/zendframework/zend-expressive">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

    <!-- content:begin -->
    <div id="page-top" class="container docs">
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#how-can-i-autowire-routes-and-pipelines">How can I autowire routes and pipelines?</a></li>
        
            <li><a href="#delegator-factories">Delegator Factories</a></li>
        
            <li><a href="#caution-pipelines">Caution: pipelines</a></li>
        
            <li><a href="#caution-third-party-distributed-modules">Caution: third-party, distributed modules</a></li>
        
            <li><a href="#synopsis">Synopsis</a></li>
        
    
    </ul>

    
    <ul class="pager hidden-print">
      <li class="previous">
        <a rel="prev" href="../../features/emitters/"><i class="fa fa-arrow-left"></i> Previous</a>
      </li>
      <li class="next">
        <a rel="next" href="../common-prefix-for-routes/">Next <i class="fa fa-arrow-right"></i></a>
      </li>
    </ul>
    
</div></div>
        <div class="col-md-9" role="main">

<ol class="breadcrumb" role="navigation" aria-label="breadcrumbs navigation">
  <li><a href="../..">Expressive</a></li>
  
    
      
        <li>Cookbook</li>
      
    
  
  <li class="active">Autowiring routes and pipeline middleware</li>
</ol>

<h1 id="how-can-i-autowire-routes-and-pipelines">How can I autowire routes and pipelines?</h1>
<p>Expressive 2.0 switches to <em>programmatic</em> piplines and routes, versus
<em>configuration-driven</em> pipelines and routing. One drawback is that with
configuration-driven approaches, users could provide configuration via a module
<code>ConfigProvider</code>, and automatically expose new pipeline middleware or routes;
with a programmatic approach, this is no longer possible.</p>
<p>Or is it?</p>
<h2 id="delegator-factories">Delegator Factories</h2>
<p>One possibility, available since the Expressive 2.X skeleton application, is to
use <em>delegator factories</em> on the <code>Zend\Expressive\Application</code> instance in order
to inject these items.</p>
<p>A <em>delegator factory</em> is a factory that <em>delegates</em> creation of an instance to a
callback, and then operates on that instance for the purpose of altering the
instance or providing a replacement (e.g., a decorator or proxy). The delegate
callback usually wraps a service factory, or, because delegator factories
<em>also</em> return an instance, additional delegator factories. As such, you assign
delegator <em>factories</em>, plural, to instances, allowing multiple delegator
factories to intercept processing of the service initialization.</p>
<p>For the purposes of this particular example, we will use delegator factories to
both <em>pipe</em> middleware as well as <em>route</em> middleware.</p>
<p>To demonstrate, we'll take the default pipeline and routing from the skeleton
application, and provide it via a delegator factory instead.</p>
<p>First, we'll create the class <code>App\Factory\PipelineAndRoutesDelegator</code>, with
the following contents:</p>
<pre class="codehilite"><code class="language-php">&lt;?php

namespace App\Factory;

use App\Action;
use Psr\Container\ContainerInterface;
use Zend\Expressive\Application;
use Zend\Expressive\Helper\ServerUrlMiddleware;
use Zend\Expressive\Helper\UrlHelperMiddleware;
use Zend\Expressive\Middleware\ImplicitHeadMiddleware;
use Zend\Expressive\Middleware\ImplicitOptionsMiddleware;
use Zend\Expressive\Middleware\NotFoundHandler;
use Zend\Stratigility\Middleware\ErrorHandler;

class PipelineAndRoutesDelegator
{
    /**
     * @param ContainerInterface $container
     * @param string $serviceName Name of the service being created.
     * @param callable $callback Creates and returns the service.
     * @return Application
     */
    public function __invoke(ContainerInterface $container, $serviceName, callable $callback)
    {
        /** @var $app Application */
        $app = $callback();

        // Setup pipeline:
        $app-&gt;pipe(ErrorHandler::class);
        $app-&gt;pipe(ServerUrlMiddleware::class);
        $app-&gt;pipeRoutingMiddleware();
        $app-&gt;pipe(ImplicitHeadMiddleware::class);
        $app-&gt;pipe(ImplicitOptionsMiddleware::class);
        $app-&gt;pipe(UrlHelperMiddleware::class);
        $app-&gt;pipeDispatchMiddleware();
        $app-&gt;pipe(NotFoundHandler::class);

        // Setup routes:
        $app-&gt;get('/', Action\HomePageAction::class, 'home');
        $app-&gt;get('/api/ping', Action\PingAction::class, 'api.ping');

        return $app;
    }
}</code></pre>

<blockquote>
<h3 id="where-to-put-the-factory">Where to put the factory</h3>
<p>You will place the factory class in one of the following locations:</p>
<ul>
<li><code>src/App/Factory/PipelineAndRoutesDelegator.php</code> if using the default, flat,
  application structure.</li>
<li><code>src/App/src/Factory/PipelineAndRoutesDelegator.php</code> if using the
  recommended, modular, application structure.</li>
</ul>
</blockquote>
<p>Once you've created this, edit the class <code>App\ConfigProvider</code>; in it, we'll
update the <code>getDependencies()</code> method to add the delegator factory:</p>
<pre class="codehilite"><code class="language-php">public function getDependencies()
{
    return [
        /* . . . */
        'delegators' =&gt; [
            \Zend\Expressive\Application::class =&gt; [
                Factory\PipelineAndRoutesDelegator::class,
            ],
        ],
    ];
}</code></pre>

<blockquote>
<h3 id="where-is-the-configprovider-class">Where is the ConfigProvider class?</h3>
<p>The <code>ConfigProvider</code> class is in one of the following locations:</p>
<ul>
<li><code>src/App/ConfigProvider.php</code> if using the default, flat, application
  structure.</li>
<li><code>src/App/src/ConfigProvider.php</code> using the recommended, modular, application
  structure.</li>
</ul>
<h3 id="why-is-an-array-assigned">Why is an array assigned?</h3>
<p>As noted above in the description of delegator factories, since each delegator
factory returns an instance, you can nest multiple delegator factories in
order to shape initialization of a service. As such, they are assigned as an
<em>array</em> to the service.</p>
</blockquote>
<p>Once you've done this, you can remove:</p>
<ul>
<li><code>config/pipeline.php</code></li>
<li><code>config/routes.php</code></li>
<li>The following lines from <code>public/index.php</code>:</li>
</ul>
<pre class="codehilite"><code class="language-php">// Import programmatic/declarative middleware pipeline and routing
// configuration statements
require 'config/pipeline.php';
require 'config/routes.php';</code></pre>

<p>If you reload your application at this point, you should see that everything
continues to work as expected!</p>
<h2 id="caution-pipelines">Caution: pipelines</h2>
<p>Using delegator factories is a nice way to keep your routing and pipeline
configuration close to the modules in which they are defined. However, there is
a caveat: you likely should <strong>not</strong> register pipeline middleware in a delegator
factory <em>other than within your root application module</em>.</p>
<p>The reason for this is simple: pipelines are linear, and specific to your
application. If one module pipes in middleware, there's no guarantee it will be
piped before or after your main pipeline, and no way to pipe the middleware at a
position in the middle of the pipeline!</p>
<p>As such:</p>
<ul>
<li>Use a <code>config/pipeline.php</code> file for your pipeline, <strong>OR</strong></li>
<li>Ensure you only define the pipeline in a <strong>single</strong> delegator factory on your
  <code>Application</code> instance.</li>
</ul>
<h2 id="caution-third-party-distributed-modules">Caution: third-party, distributed modules</h2>
<p>If you are developing a module to distribute as a package via
<a href="https://getcomposer.org/">Composer</a>, <strong>you should not autowire any delegator
factories that inject pipeline middleware or routes in the <code>Application</code></strong>.</p>
<p>Why?</p>
<p>As noted in the above section, pipelines should be created exactly once, at
the application level. Registering pipeline middleware within a distributable
package will very likely not have the intended consequences.</p>
<p>If you ship with pipeline middleware, we suggest that you:</p>
<ul>
<li>Document the middleware, and where you anticipate it being used in the
  middleware pipeline.</li>
<li>Document how to add the middleware service to dependency configuration, or
  provide the dependency configuration via your module's <code>ConfigProvider</code>.</li>
</ul>
<p>With regards to routes, there are other considerations:</p>
<ul>
<li>
<p>Routes defined by the package might conflict with the application, or with
  other packages used by the application.</p>
</li>
<li>
<p>Routing definitions are typically highly specific to the router implementation
  in use. As an example, each of the currently supported router implementations
  has a different syntax for placeholders:</p>
<ul>
<li><code>/user/:id</code> + "constraints" configuration to define constraints (zend-router)</li>
<li><code>/user/{id}</code> + "tokens" configuration to define constraints (Aura.Router)</li>
<li><code>/user/{id:\d+}</code> (FastRoute)</li>
</ul>
</li>
<li>
<p>Your application may have specific routing considerations or design.</p>
</li>
</ul>
<p>You could, of course, detect what router is in use, and provide routing for each
known, supported router implementation within your delegator factory. We even
recommend doing exactly that. However, we note that such an approach does not
solve the other two points above.</p>
<p>However, we still recommend <em>shipping</em> a delegator factory that would register
your routes, since routes <em>are</em> often a part of module design; just <strong>do not
autowire</strong> that delegator factory. This way, end-users who <em>can</em> use the
defaults do not need to cut-and-paste routing definitions from your
documentation into their own applications; they will instead opt-in to your
delegator factory by wiring it into their own configuration.</p>
<h2 id="synopsis">Synopsis</h2>
<ul>
<li>We recommend using delegator factories for the purpose of autowiring routes,
  and, with caveats, pipeline middleware:<ul>
<li>The pipeline should be created exactly once, so calls to <code>pipe()</code> should
  occur in exactly <em>one</em> delegator factory.</li>
</ul>
</li>
<li>Distributable packages should create a delegator factory for <em>routes only</em>,
  but <em>should not</em> register the delegator factory by default.</li>
</ul>

<hr />


<nav>
  <ul class="pager hidden-print">
    <li class="previous">
      <a rel="prev" href="../../features/emitters/"><i class="fa fa-arrow-left"></i> Previous</a>
    </li>
    <li class="next">
      <a rel="next" href="../common-prefix-for-routes/">Next <i class="fa fa-arrow-right"></i></a>
    </li>
  </ul>
</nav>
</div>
        
    </div>
    <!-- content:end -->

    <div id="footerwrap">
    <div class="container">
        <div class="row site-map">
            <div class="col-lg-3">
              <p>
                <strong>Zend Framework</strong><br />
                <a href="http://framework.zend.com/">framework.zend.com</a><br />
                <a href="https://docs.zendframework.com">docs.zendframework.com</a><br />
                <a href="https://packages.zendframework.com">packages.zendframework.com</a><br />
                <a href="https://apigility.org">apigility.org</a><br />
              </p>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 centered">
                <a class="back-to-top" href="#page-top"><i class="fa fa-chevron-circle-up fa-4" aria-hidden="true"></i></a>
            </div>
        </div>

        <div class="spacing"></div>

        <div class="row">
            <div class="col-lg-8">
                <h4>Copyright</h4>
                <div class="hline-w"></div>

                <p>&copy; 2006-2016 by <a href="http://www.zend.com">Zend</a>, a <a href="http://www.roguewave.com/">Rogue Wave Company</a>.</p>
            </div>

            <div class="col-lg-4">
                <h4>Contacts</h4>
                <div class="hline-w"></div>
                <p>
                    <a href="irc://irc.freenode.net/zftalk" class="btn-social btn-outline" alt="IRC" title="IRC"><i class="fa fa-comment"></i></a>
                    <a href="https://github.com/zendframework" class="btn-social btn-outline" alt="Github" title="Github"><i class="fa fa-github"></i></a>
                    <a href="https://twitter.com/zfdevteam" class="btn-social btn-outline" alt="Twitter" title="Twitter"><i class="fa fa-twitter"></i></a>
                </p>
            </div>
        </div>
    </div>
</div>


    <script src="//cdn.jsdelivr.net/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
    <script src="//cdn.jsdelivr.net/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha256-KXn5puMvxCw+dAYznun+drMdG1IFl3agK0p/pqT9KAo=" crossorigin="anonymous"></script>
    <script>var base_url = '../..';</script>
    <script src="../../js/scripts-8b95ab2fc3.js"></script>
    <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    <div class="zf-components">
  <div class="zf-components-grid">
    <div class="zf-logo">
      <a href="http://framework.zend.com" data-toggle="tooltip" data-placement="bottom" title="Go to the ZF homepage"><img src="../../img/zf-logo-mark.svg" alt="Zend Framework" width="250" /></a>
    </div>

    <div class="component-list"></div>

    <p class="zf-components-rollup"><a href="#">Hide list</a></p>
  </div>
</div>

</body>

</html>
