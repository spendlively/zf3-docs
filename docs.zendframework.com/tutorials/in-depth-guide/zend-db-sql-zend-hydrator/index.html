<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <link rel="shortcut icon" href="../../img/favicon.ico">

    <title>SQL Abstraction and Object Hydration - tutorials</title>

    <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.018/css/hack.min.css">
    <link href="//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Libre+Baskerville:400,400italic,700&subset=latin,latin-ext" rel="stylesheet" type="text/css">
    <link href="../../css/base.css" rel="stylesheet">
    <link href="../../css/zf-web.css" rel="stylesheet">
    <link href="../../css/zf.css" rel="stylesheet">
    <link href="../../css/prism-zf.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Open Sans', 'PT Sans']
        }
    });
    </script>

    
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <span class="navbar-brand">
              <a class="logo-link" href="http://framework.zend.com" data-toggle="tooltip" data-placement="bottom" title="Zend Framework"><img src="../../img/zf-logo-mark.svg" height="28" alt="Zend Framework" /></a>
              <a href="../..">tutorials</a>
            </span>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../..">Home</a>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">MVC Tutorials <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Getting Started with Zend Framework</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../getting-started/overview/">Overview</a>
</li>

        
            
<li >
    <a href="../../getting-started/skeleton-application/">The Skeleton Application</a>
</li>

        
            
<li >
    <a href="../../getting-started/modules/">Modules</a>
</li>

        
            
<li >
    <a href="../../getting-started/routing-and-controllers/">Routing and Controllers</a>
</li>

        
            
<li >
    <a href="../../getting-started/database-and-models/">Database and Models</a>
</li>

        
            
<li >
    <a href="../../getting-started/forms-and-actions/">Forms and Actions</a>
</li>

        
            
<li >
    <a href="../../getting-started/conclusion/">Conclusion</a>
</li>

        
    </ul>
  </li>

                        
                            
<li >
    <a href="../../unit-testing/">Unit Testing A zend-mvc Application</a>
</li>

                        
                            
<li >
    <a href="../../navigation/">Adding zend-navigation to the Album Module</a>
</li>

                        
                            
<li >
    <a href="../../pagination/">Adding zend-paginator to the Album Module</a>
</li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">In-Depth Tutorial</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../first-module/">Introducing the Blog Module</a>
</li>

        
            
<li >
    <a href="../models-and-servicemanager/">Models and the ServiceManager</a>
</li>

        
            
<li >
    <a href="../preparing-databases/">Preparing for Different Databases</a>
</li>

        
            
<li class="active">
    <a href="./">SQL Abstraction and Object Hydration</a>
</li>

        
            
<li >
    <a href="../understanding-routing/">Understanding the Router</a>
</li>

        
            
<li >
    <a href="../zend-form-zend-form-fieldset/">Making Use of Forms and Fieldsets</a>
</li>

        
            
<li >
    <a href="../data-binding/">Editing and Deleting Data</a>
</li>

        
            
<li >
    <a href="../review/">Reviewing the Blog Module</a>
</li>

        
    </ul>
  </li>

                        
                            
<li >
    <a href="../../advanced-config/">Advanced Configuration</a>
</li>

                        
                            
<li >
    <a href="../../i18n/">Internationalization</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Component Tutorials <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../db-adapter/">Setting Up A Database Adapter</a>
</li>

                        
                            
<li >
    <a href="../../event-manager/">Using the EventManager</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Migration <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">To Version 3</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../migration/to-v3/overview/">Overview</a>
</li>

        
            
<li >
    <a href="../../migration/to-v3/components/">Components</a>
</li>

        
            
<li >
    <a href="../../migration/to-v3/application/">Applications</a>
</li>

        
    </ul>
  </li>

                        
                        </ul>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" class="component-toggle" data-toggle="tooltip" data-placement="bottom" title="Show component list">
                        <i class="fa fa-book"></i> Components
                    </a>
                </li>

                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li>
                        <a href="https://github.com/zendframework/tutorials">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

    <!-- content:begin -->
    <div id="page-top" class="container docs">
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#sql-abstraction-and-object-hydration">SQL Abstraction and Object Hydration</a></li>
        
            <li><a href="#preparing-the-database">Preparing the Database</a></li>
        
            <li><a href="#quick-facts-zend92db92sql">Quick Facts Zend\Db\Sql</a></li>
        
            <li><a href="#writing-the-repository-implementation">Writing the repository implementation</a></li>
        
            <li><a href="#refactoring-hidden-dependencies">Refactoring hidden dependencies</a></li>
        
            <li><a href="#finishing-the-repository">Finishing the repository</a></li>
        
            <li><a href="#conclusion">Conclusion</a></li>
        
    
    </ul>

    
    <ul class="pager hidden-print">
      <li class="previous">
        <a rel="prev" href="../preparing-databases/"><i class="fa fa-arrow-left"></i> Previous</a>
      </li>
      <li class="next">
        <a rel="next" href="../understanding-routing/">Next <i class="fa fa-arrow-right"></i></a>
      </li>
    </ul>
    
</div></div>
        <div class="col-md-9" role="main">

<ol class="breadcrumb" role="navigation" aria-label="breadcrumbs navigation">
  <li><a href="../..">tutorials</a> &raquo;</li>
  
    
      
        <li>MVC Tutorials &raquo;</li>
      
    
      
        <li>In-Depth Tutorial &raquo;</li>
      
    
  
  <li class="active">SQL Abstraction and Object Hydration</li>
</ol>

<h1 id="sql-abstraction-and-object-hydration">SQL Abstraction and Object Hydration</h1>
<p>In the last chapter, we introduced database abstraction and a new command
interface for operations that might change what blog posts we store. We'll now
start creating database-backed versions of the <code>PostRepositoryInterface</code> and
<code>PostCommandInterface</code>, demonstrating usage of the various <code>Zend\Db\Sql</code>
classes.</p>
<h2 id="preparing-the-database">Preparing the Database</h2>
<p>This tutorial assumes you've followed the <a href="../../getting-started/overview/">Getting Started</a>
tutorial, and that you've already populated the <code>data/zftutorial.db</code> SQLite
database. We will be re-using it, and adding another table to it.</p>
<p>Create the file <code>data/posts.schema.sql</code> with the following contents:</p>
<pre class="codehilite"><code class="language-sql linenums">CREATE TABLE posts (id INTEGER PRIMARY KEY AUTOINCREMENT, title varchar(100) NOT NULL, text TEXT NOT NULL);

INSERT INTO posts (title, text) VALUES ('Blog #1', 'Welcome to my first blog post');
INSERT INTO posts (title, text) VALUES ('Blog #2', 'Welcome to my second blog post');
INSERT INTO posts (title, text) VALUES ('Blog #3', 'Welcome to my third blog post');
INSERT INTO posts (title, text) VALUES ('Blog #4', 'Welcome to my fourth blog post');
INSERT INTO posts (title, text) VALUES ('Blog #5', 'Welcome to my fifth blog post');</code></pre>

<p>Now we will execute this against the existing <code>data/zftutorial.db</code> SQLite
database using the <code>sqlite</code> command (or <code>sqlite3</code>; check your operating system):</p>
<pre class="codehilite"><code class="language-bash linenums">$ sqlite data/zftutorial.db &lt; data/posts.schema.sql</code></pre>

<p>If you don't have a <code>sqlite</code> command, you can populate it using PHP. Create the
following script in <code>data/load_posts.php</code>:</p>
<pre class="codehilite"><code class="language-php linenums">&lt;?php
$db = new PDO('sqlite:' . realpath(__DIR__) . 'zftutorial.db');
$fh = fopen(__DIR__ . '/posts.schema.sql', 'r');
while ($line = fread($fh, 4096)) {
    $line = trim($line);
    $db-&gt;exec($line);
}
fclose($fh);</code></pre>

<p>and execute it using:</p>
<pre class="codehilite"><code class="language-bash linenums">$ php data/load_posts.php</code></pre>

<h2 id="quick-facts-zend92db92sql">Quick Facts Zend\Db\Sql</h2>
<p>To create queries against a database using <code>Zend\Db\Sql</code>, you need to have a
database adapter available. The "Getting Started" tutorial
<a href="../../getting-started/database-and-models/#using-servicemanager-to-configure-the-table-gateway-and-inject-into-the-albumtable">covered this in the database chapter</a>,
and we can re-use that adapter.</p>
<p>With the adapter in place and the new table populated, we can run queries
against the database. The construction of queries is best done through the
"QueryBuilder" features of <code>Zend\Db\Sql</code> which are <code>Zend\Db\Sql\Sql</code> for select
queries, <code>Zend\Db\Sql\Insert</code> for insert queries, <code>Zend\Db\Sql\Update</code> for
update queries and <code>Zend\Db\Sql\Delete</code> for delete queries. The basic workflow
of these components is:</p>
<ol>
<li>Build a query using the relevant class: <code>Sql</code>, <code>Insert</code>, <code>Update</code>, or
   <code>Delete</code>.</li>
<li>Create a SQL statement from the <code>Sql</code> object.</li>
<li>Execute the query.</li>
<li>Do something with the result.</li>
</ol>
<p>Let's start writing database-driven implementations of our interfaces now.</p>
<h2 id="writing-the-repository-implementation">Writing the repository implementation</h2>
<p>Create a class named <code>ZendDbSqlRepository</code> in the <code>Blog\Model</code> namespace that
implements <code>PostRepositoryInterface</code>; leave the methods empty for now:</p>
<pre class="codehilite"><code class="language-php linenums">// In module/Blog/src/Model/ZendDbSqlRepository.php:
namespace Blog\Model;

use InvalidArgumentException;
use RuntimeException;

class ZendDbSqlRepository implements PostRepositoryInterface
{
    /**
     * {@inheritDoc}
     */
    public function findAllPosts()
    {
    }

    /**
     * {@inheritDoc}
     * @throws InvalidArgumentException
     * @throws RuntimeException
     */
    public function findPost($id)
    {
    }
}</code></pre>

<p>Now recall what we have learned earlier: for <code>Zend\Db\Sql</code> to function, we will
need a working implementation of the <code>AdapterInterface</code>. This is a
<em>requirement</em>, and therefore will be injected using <em>constructor injection</em>.
Create a <code>__construct()</code> method that accepts an <code>AdapterInterface</code> as its sole
parameter, and stores it as an instance property:</p>
<pre class="codehilite"><code class="language-php linenums">// In module/Blog/src/Model/ZendDbSqlRepository.php:
namespace Blog\Model;

use InvalidArgumentException;
use RuntimeException;
use Zend\Db\Adapter\AdapterInterface;

class ZendDbSqlRepository implements PostRepositoryInterface
{
    /**
     * @var AdapterInterface
     */
    private $db;

    /**
     * @param AdapterInterface $db
     */
    public function __construct(AdapterInterface $db)
    {
        $this-&gt;db = $db;
    }

    /**
     * {@inheritDoc}
     */
    public function findAllPosts()
    {
    }

    /**
     * {@inheritDoc}
     * @throws InvalidArgumentException
     * @throws RuntimeException
     */
    public function findPost($id)
    {
    }
}</code></pre>

<p>Whenever we have a required parameter, we need to write a factory for the class.
Go ahead and create a factory for our new repository implementation:</p>
<pre class="codehilite"><code class="language-php linenums">// In module/Blog/src/Factory/ZendDbSqlRepositoryFactory.php
namespace Blog\Factory;

use Interop\Container\ContainerInterface;
use Blog\Model\ZendDbSqlRepository;
use Zend\Db\Adapter\AdapterInterface;
use Zend\ServiceManager\Factory\FactoryInterface;

class ZendDbSqlRepositoryFactory implements FactoryInterface
{
    /**
     * @param ContainerInterface $container
     * @param string $requestedName
     * @param null|array $options
     * @return ZendDbSqlRepository
     */
    public function __invoke(ContainerInterface $container, $requestedName, array $options = null)
    {
        return new ZendDbSqlRepository($container-&gt;get(AdapterInterface::class));
    }
}</code></pre>

<p>We're now able to register our repository implementation as a service. To do so,
we'll make two changes:</p>
<ul>
<li>Register a factory entry for the new repository.</li>
<li>Update the existing alias for <code>PostRepositoryInterface</code> to point to the new
  repository.</li>
</ul>
<p>Update <code>module/Blog/config/module.config.php</code> as follows:</p>
<pre class="codehilite"><code class="language-php linenums">return [
    'service_manager' =&gt; [
        'aliases' =&gt; [
            // Update this line:
            Model\PostRepositoryInterface::class =&gt; Model\ZendDbSqlRepository::class,
        ],
        'factories' =&gt; [
            Model\PostRepository::class =&gt; InvokableFactory::class,
            // Add this line:
            Model\ZendDbSqlRepository::class =&gt; Factory\ZendDbSqlRepositoryFactory::class,
        ],
    ],
    'controllers'  =&gt; [ /* ... */ ],
    'router'       =&gt; [ /* ... */ ],
    'view_manager' =&gt; [ /* ... */ ],
];</code></pre>

<p>With the adapter in place you're now able to refresh the blog index at
<code>localhost:8080/blog</code> and you'll notice that the <code>ServiceNotFoundException</code> is
gone and we get the following PHP Warning:</p>
<pre class="codehilite"><code class="language-text linenums">Warning: Invalid argument supplied for foreach() in {projectPath}/module/Blog/view/blog/list/index.phtml on line {lineNumber}</code></pre>

<p>This is due to the fact that our mapper doesn't return anything yet. Let's
modify the <code>findAllPosts()</code> function to return all blog posts from the database
table:</p>
<pre class="codehilite"><code class="language-php linenums">// In /module/Blog/src/Model/ZendDbSqlRepository.php:
namespace Blog\Model;

use InvalidArgumentException;
use RuntimeException
use Zend\Db\Adapter\AdapterInterface;
use Zend\Db\Sql\Sql;

class ZendDbSqlRepository implements PostRepositoryInterface
{
    /**
     * @var AdapterInterface
     */
    private $db;

    /**
     * @param AdapterInterface $db
     */
    public function __construct(AdapterInterface $db)
    {
        $this-&gt;db = $db;
    }

    /**
     * {@inheritDoc}
     */
    public function findAllPosts()
    {
        $sql    = new Sql($this-&gt;db);
        $select = $sql-&gt;select('posts');
        $stmt   = $sql-&gt;prepareStatementForSqlObject($select);
        $result = $stmt-&gt;execute();
        return $result;
    }

    /**
     * {@inheritDoc}
     * @throws InvalidArgumentException
     * @throw RuntimeException
     */
    public function findPost($id)
    {
    }
}</code></pre>

<p>Sadly, though, a refresh of the application reveals another error message:</p>
<pre class="codehilite"><code class="language-text linenums">PHP Fatal error:  Call to a member function getId() on array in {projectPath}/module/Blog/view/blog/list/index.phtml on line {lineNumber}</code></pre>

<p>Let's not return the <code>$result</code> variable for now and do a dump of it to see what
we get here. Change the <code>findAllPosts()</code> method and dump the result:</p>
<pre class="codehilite"><code class="language-php linenums">public function findAllPosts()
{
    $sql    = new Sql($this-&gt;db);
    $select = $sql-&gt;select('posts');
    $stmt   = $sql-&gt;prepareStatementForSqlObject($select);
    $result = $stmt-&gt;execute();

    var_export($result);
    die();

    return $result;
}</code></pre>

<p>Refreshing the application you should now see output similar to the following:</p>
<pre class="codehilite"><code class="language-text linenums">Zend\Db\Adapter\Driver\Pdo\Result::__set_state(array(
    'statementMode'   =&gt; 'forward',
    'fetchMode'       =&gt; 2,
    'resource'        =&gt; PDOStatement::__set_state(array(
        'queryString' =&gt; 'SELECT &quot;posts&quot;.* FROM &quot;posts&quot;',
    )),
    'options'         =&gt; null,
    'currentComplete' =&gt; false,
    'currentData'     =&gt; null,
    'position'        =&gt; -1,
    'generatedValue'  =&gt; '0',
    'rowCount'        =&gt; Closure::__set_state(array()),
))</code></pre>

<p>As you can see, we do not get any data returned. Instead we are presented with a
dump of some <code>Result</code> object that appears to have no data in it whatsoever. But
this is a faulty assumption. This <code>Result</code> object only has information available
for you when you actually try to access it. If you can determine that the query
was successful, the best way to make use of the data within the <code>Result</code> object
is to pass it to a <code>ResultSet</code> object.</p>
<p>First, add two more import statements to the class file:</p>
<pre class="codehilite"><code class="language-php linenums">use Zend\Db\Adapter\Driver\ResultInterface;
use Zend\Db\ResultSet\ResultSet;</code></pre>

<p>Now update the <code>findAllPosts()</code> method as follows:</p>
<pre class="codehilite"><code class="language-php linenums">public function findAllPosts()
{
    $sql    = new Sql($this-&gt;db);
    $select = $sql-&gt;select('posts');
    $stmt   = $sql-&gt;prepareStatementForSqlObject($select);
    $result = $stmt-&gt;execute();

    if ($result instanceof ResultInterface &amp;&amp; $result-&gt;isQueryResult()) {
        $resultSet = new ResultSet();
        $resultSet-&gt;initialize($result);
        var_export($resultSet);
        die();
    }

    die('no data');
}</code></pre>

<p>Refreshing the page, you should now see the dump of a <code>ResultSet</code> instance:</p>
<pre class="codehilite"><code class="language-text linenums">Zend\Db\ResultSet\ResultSet::__set_state(array(
    'allowedReturnTypes'   =&gt;
        array(
            0 =&gt; 'arrayobject',
            1 =&gt; 'array',
        ),
    'arrayObjectPrototype' =&gt;
        ArrayObject::__set_state(array(
        )),
    'returnType'           =&gt; 'arrayobject',
    'buffer'               =&gt; null,
    'count'                =&gt; null,
    'dataSource'           =&gt;
        Zend\Db\Adapter\Driver\Pdo\Result::__set_state(array(
            'statementMode'   =&gt; 'forward',
            'fetchMode'       =&gt; 2,
            'resource'        =&gt;
                PDOStatement::__set_state(array(
                    'queryString' =&gt; 'SELECT &quot;album&quot;.* FROM &quot;album&quot;',
                )),
            'options'         =&gt; null,
            'currentComplete' =&gt; false,
            'currentData'     =&gt; null,
            'position'        =&gt; -1,
            'generatedValue'  =&gt; '0',
            'rowCount'        =&gt;
                Closure::__set_state(array(
                )),
        )),
    'fieldCount'           =&gt; 3,
    'position'             =&gt; 0,
))</code></pre>

<p>Of particular interest is the <code>returnType</code> property, which has a value of
<code>arrayobject</code>.  This tells us that all database entries will be returned as an
<code>ArrayObject</code> instances. And this is a little problem for us, as the
<code>PostRepositoryInterface</code> requires us to return an array of <code>Post</code> instances.
Luckily the <code>Zend\Db\ResultSet</code> subcomponent offers a solution for us, via the
<code>HydratingResultSet</code>; this result set type will populate an object of a type we
specify with the data returned.</p>
<p>Let's modify our code. First, remove the following import statement from the
class file:</p>
<pre class="codehilite"><code class="language-php linenums">use Zend\Db\ResultSet\ResultSet;</code></pre>

<p>Next, we'll add the following import statements to our class file:</p>
<pre class="codehilite"><code class="language-php linenums">use Zend\Hydrator\Reflection as ReflectionHydrator;
use Zend\Db\ResultSet\HydratingResultSet;</code></pre>

<p>Now, update the <code>findAllPosts()</code> method to read as follows:</p>
<pre class="codehilite"><code class="language-php linenums">public function findAllPosts()
{
    $sql       = new Sql($this-&gt;db);
    $select    = $sql-&gt;select('posts');
    $statement = $sql-&gt;prepareStatementForSqlObject($select);
    $result    = $statement-&gt;execute();

    if (! $result instanceof ResultInterface || ! $result-&gt;isQueryResult()) {
        return [];
    }

    $resultSet = new HydratingResultSet(
        new ReflectionHydrator(),
        new Post('', '')
    );
    $resultSet-&gt;initialize($result);
    return $resultSet;
}</code></pre>

<p>We have changed a couple of things here. First, instead of a normal <code>ResultSet</code>,
we are now using the <code>HydratingResultSet</code>. This specialized result set requires two parameters, the
second one being an object to hydrate with data, and the first one being the
<code>hydrator</code> that will be used (a <code>hydrator</code> is an object that will transform an
array of data into an object, and vice versa). We use <code>Zend\Hydrator\Reflection</code>
here, which is capable of injecting private properties of an instance. We
provide an empty <code>Post</code> instance, which the hydrator will clone to create new
instances with data from individual rows.</p>
<p>Instead of dumping the <code>$result</code> variable, we now directly return the
initialized <code>HydratingResultSet</code> so we can access the data stored within. In
case we get something else returned that is not an instance of a
<code>ResultInterface</code>, we return an empty array.</p>
<p>Refreshing the page you will now see all your blog posts listed on the page. Great!</p>
<h2 id="refactoring-hidden-dependencies">Refactoring hidden dependencies</h2>
<p>There's one little thing that we have done that's not a best-practice. We use
both a hydrator and an <code>Post</code> prototype inside our <code>ZendDbSqlRepository</code>. Let's
inject those instead, so that we can reuse them between our repository and
command implementations, or vary them based on environment. Update your
<code>ZendDbSqlRepository</code> as follows:</p>
<pre class="codehilite"><code class="language-php linenums">// In module/Blog/src/Model/ZendDbSqlRepository.php:
namespace Blog\Model;

use InvalidArgumentException;
use RuntimeException;
// Replace the import of the Reflection hydrator with this:
use Zend\Hydrator\HydratorInterface;
use Zend\Db\Adapter\AdapterInterface;
use Zend\Db\Adapter\Driver\ResultInterface;
use Zend\Db\ResultSet\HydratingResultSet;
use Zend\Db\Sql\Sql;

class ZendDbSqlRepository implements PostRepositoryInterface
{
    /**
     * @var AdapterInterface
     */
    private $db;

    /**
     * @var HydratorInterface
     */
    private $hydrator;

    /**
     * @var Post
     */
    private $postPrototype;

    public function __construct(
        AdapterInterface $db,
        HydratorInterface $hydrator,
        Post $postPrototype
    ) {
        $this-&gt;db            = $db;
        $this-&gt;hydrator      = $hydrator;
        $this-&gt;postPrototype = $postPrototype;
    }

    /**
     * Return a set of all blog posts that we can iterate over.
     *
     * Each entry should be a Post instance.
     *
     * @return Post[]
     */
    public function findAllPosts()
    {
        $sql       = new Sql($this-&gt;db);
        $select    = $sql-&gt;select('posts');
        $statement = $sql-&gt;prepareStatementForSqlObject($select);
        $result    = $statement-&gt;execute();

        if (! $result instanceof ResultInterface || ! $result-&gt;isQueryResult()) {
            return [];
        }

        $resultSet = new HydratingResultSet($this-&gt;hydrator, $this-&gt;postPrototype);
        $resultSet-&gt;initialize($result);
        return $resultSet;
    }

    /**
     * Return a single blog post.
     *
     * @param  int $id Identifier of the post to return.
     * @return Post
     */
    public function findPost($id)
    {
    }
}</code></pre>

<p>Now that our repository requires more parameters, we need to update the
<code>ZendDbSqlRepositoryFactory</code> and inject those parameters:</p>
<pre class="codehilite"><code class="language-php linenums">// In /module/Blog/src/Factory/ZendDbSqlRepositoryFactory.php
namespace Blog\Factory;

use Interop\Container\ContainerInterface;
use Blog\Model\Post;
use Blog\Model\ZendDbSqlRepository;
use Zend\Db\Adapter\AdapterInterface;
use Zend\Hydrator\Reflection as ReflectionHydrator;
use Zend\ServiceManager\Factory\FactoryInterface;

class ZendDbSqlRepositoryFactory implements FactoryInterface
{
    public function __invoke(ContainerInterface $container, $requestedName, array $options = null)
    {
        return new ZendDbSqlRepository(
            $container-&gt;get(AdapterInterface::class),
            new ReflectionHydrator(),
            new Post('', '')
        );
    }
}</code></pre>

<p>With this in place you can refresh the application again and you'll see your
blog posts listed once again. Our repository no longer has hidden dependencies,
and works with a database!</p>
<h2 id="finishing-the-repository">Finishing the repository</h2>
<p>Before we jump into the next chapter, let's quickly finish the repository
implementation by completing the <code>findPost()</code> method:</p>
<pre class="codehilite"><code class="language-php linenums">public function findPost($id)
{
    $sql       = new Sql($this-&gt;db);
    $select    = $sql-&gt;select('posts');
    $select-&gt;where(['id = ?' =&gt; $id]);

    $statement = $sql-&gt;prepareStatementForSqlObject($select);
    $result    = $statement-&gt;execute();

    if (! $result instanceof ResultInterface || ! $result-&gt;isQueryResult()) {
        throw new RuntimeException(sprintf(
            'Failed retrieving blog post with identifier &quot;%s&quot;; unknown database error.',
            $id
        ));
    }

    $resultSet = new HydratingResultSet($this-&gt;hydrator, $this-&gt;postPrototype);
    $resultSet-&gt;initialize($result);
    $post = $resultSet-&gt;current();

    if (! $post) {
        throw new InvalidArgumentException(sprintf(
            'Blog post with identifier &quot;%s&quot; not found.',
            $id
        ));
    }

    return $post;
}</code></pre>

<p>The <code>findPost()</code> function looks similar to the <code>findAllPosts()</code> method, with
several differences.</p>
<ul>
<li>We need to add a condition to the query to select only the row matching the
  provided identifier; this is done using the <code>where()</code> method of the <code>Sql</code>
  object.</li>
<li>We check if the <code>$result</code> is valid, using <code>isQueryResult()</code>; if not, an error
  occurred during the query that we report via a <code>RuntimeException</code>.</li>
<li>We pull the <code>current()</code> item off the result set we create, and test to make
  sure we received something; if not, we had an invalid identifier, and raise an
  <code>InvalidArgumentException</code>.</li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>Finishing this chapter, you now know how to <em>query</em> for data using the
<code>Zend\Db\Sql</code> classes. You have also learned a little about the zend-hydrator
component, and the integration zend-db provides with it.  Furthermore, we've
continued demonstrating dependency injection in all aspects of our application.</p>
<p>In the next chapter we'll take a closer look at the router so we'll be able to
start displaying individual blog posts.</p>

<hr />


<nav>
  <ul class="pager hidden-print">
    <li class="previous">
      <a rel="prev" href="../preparing-databases/"><i class="fa fa-arrow-left"></i> Previous</a>
    </li>
    <li class="next">
      <a rel="next" href="../understanding-routing/">Next <i class="fa fa-arrow-right"></i></a>
    </li>
  </ul>
</nav>
</div>
        
    </div>
    <!-- content:end -->

    <div id="footerwrap">
    <div class="container">
        <div class="row site-map">
            <div class="col-lg-3">
              <p>
                <strong>Zend Framework</strong><br />
                <a href="http://framework.zend.com/">framework.zend.com</a><br />
                <a href="https://docs.zendframework.com">docs.zendframework.com</a><br />
                <a href="https://packages.zendframework.com">packages.zendframework.com</a><br />
                <a href="https://apigility.org">apigility.org</a><br />
              </p>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 centered">
                <a class="back-to-top" href="#page-top"><i class="fa fa-chevron-circle-up fa-4" aria-hidden="true"></i></a>
            </div>
        </div>

        <div class="spacing"></div>

        <div class="row">
            <div class="col-lg-8">
                <h4>Copyright</h4>
                <div class="hline-w"></div>

                <p>&copy; 2006-2016 by <a href="http://www.zend.com">Zend</a>, a <a href="http://www.roguewave.com/">Rogue Wave Company</a>.</p>
            </div>

            <div class="col-lg-4">
                <h4>Contacts</h4>
                <div class="hline-w"></div>
                <p>
                    <a href="irc://irc.freenode.net/zftalk" class="btn-social btn-outline" alt="IRC" title="IRC"><i class="fa fa-comment"></i></a>
                    <a href="https://github.com/zendframework" class="btn-social btn-outline" alt="Github" title="Github"><i class="fa fa-github"></i></a>
                    <a href="https://twitter.com/zfdevteam" class="btn-social btn-outline" alt="Twitter" title="Twitter"><i class="fa fa-twitter"></i></a>
                </p>
            </div>
        </div>
    </div>
</div>


    <script src="../../js/jquery-1.10.2.min.js"></script>
    <script src="../../js/bootstrap-3.0.3.min.js"></script>
    <script src="../../js/prism-zf.js"></script>

    <script>var base_url = '../..';</script>
    <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
    <script src="../../js/base.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    <div class="zf-components">
  <div class="zf-components-grid">
    <div class="zf-logo">
      <a href="http://framework.zend.com" data-toggle="tooltip" data-placement="bottom" title="Go to the ZF homepage"><img src="../../img/zf-logo-mark.svg" alt="Zend Framework" width="250" /></a>
    </div>

    <div class="component-list"></div>

    <p class="zf-components-rollup"><a href="#">Hide list</a></p>
  </div>
</div>

    <script>
  // Prepare the component list dropdown for display
  $(function () {
    var components = $(".zf-components"),
        componentList = components.find(".component-list"),
        sidebar = $(".bs-sidebar.affix"),
        sidebarInitialPos = sidebar.css("position"),
        hidden,
        componentToggle = $(".component-toggle"),
        navbar = $(".navbar-fixed-top"),
        rollUpLink = $(".zf-components-rollup a");

    // Initial setup on document load
    components.insertBefore(navbar);
    $(".zf-logo a").tooltip();
    componentToggle.tooltip();
    rollUpLink.attr({ href: "#", alt: "Hide component list" });

    // Cast initial sidebar position value
    if (undefined === sidebarInitialPos) {
      sidebarInitialPos = "fixed";
    }

    // Setup onclick events to toggle list
    componentToggle.click(toggleComponentList);
    rollUpLink.click(toggleComponentList);

    // Toggle the component list display
    function toggleComponentList(event) {
      event.preventDefault();

      if (hidden === undefined) {
        // Not loaded yet; load and display.
        loadComponentList();
        return;
      }

      if (hidden) {
        // Hidden; display.
        showComponentList();
        return;
      }

      // Currently visible; hide
      hideComponentList();
    }

    // Show the component list
    function showComponentList() {
      navbar.css({position: "relative"});
      sidebar.css({position: "relative"});
      components
        .css({"margin-top": "-" + components.outerHeight() + "px"})
        .show()
        .animate({"margin-top": 0}, {
          complete: function () {
            componentToggle
              .data("placement", "top")
              .attr("data-original-title", "Hide component list");
            hidden = false;
          },
          queue: false
        });
    }

    // Hide the component list
    function hideComponentList() {
      components.animate({"margin-top": "-" + components.outerHeight() + "px"}, {
        complete: function () {
          navbar.css({position: "fixed"});
          sidebar.css({position: sidebarInitialPos});
          componentToggle
            .data("placement", "bottom")
            .attr("data-original-title", "Show component list");
          components.hide();
          hidden = true;
        },
        queue: false
      });
      sidebar.animate({ top: sidebarInitialTop + "px" }, { queue: false});
    }

    // Inject a component into the componet list DOM.
    function injectComponent(index, component) {
      componentList.append('<div class="component"><h4><a href="' + component.url + '">' + component.name + '</a></h4><p>' + component.description + '</p></div>');
    }

    // Parse the component list, build the DOM, and display it.
    function parseComponentList(components) {
      $.each(components, injectComponent);
      showComponentList();
    }

    // Fetch the component list and display it.
    function loadComponentList () {
      $.ajax({
        url: "//docs.zendframework.com/zf-mkdoc-theme/scripts/zf-component-list.json",
        dataType: "text json",
        success: parseComponentList,
        error: function (e) {
          console.log("Error occurred with XHR call", e);
        }
      });
    }
  });
</script>
    </body>

</html>
