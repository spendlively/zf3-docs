<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <link rel="shortcut icon" href="../../img/favicon.ico">

    <title>v2.X to v2.7 - zend-mvc</title>

    <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.018/css/hack.min.css">
    <link href="//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Libre+Baskerville:400,400italic,700&subset=latin,latin-ext" rel="stylesheet" type="text/css">
    <link href="../../css/base.css" rel="stylesheet">
    <link href="../../css/zf-web.css" rel="stylesheet">
    <link href="../../css/zf.css" rel="stylesheet">
    <link href="../../css/prism-zf.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Open Sans', 'PT Sans']
        }
    });
    </script>

    
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <span class="navbar-brand">
              <a class="logo-link" href="http://framework.zend.com" data-toggle="tooltip" data-placement="bottom" title="Zend Framework"><img src="../../img/zf-logo-mark.svg" height="28" alt="Zend Framework" /></a>
              <a href="../..">zend-mvc</a>
            </span>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../..">Home</a>
                    </li>
                
                
                
                    <li >
                        <a href="../../intro/">Introduction</a>
                    </li>
                
                
                
                    <li >
                        <a href="../../quick-start/">Quick Start</a>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../services/">Default Services</a>
</li>

                        
                            
<li >
    <a href="../../routing/">Routing</a>
</li>

                        
                            
<li >
    <a href="../../mvc-event/">The MVC Event</a>
</li>

                        
                            
<li >
    <a href="../../send-response-event/">The SendResponse Event</a>
</li>

                        
                            
<li >
    <a href="../../controllers/">Available Controllers</a>
</li>

                        
                            
<li >
    <a href="../../plugins/">Controller Plugins</a>
</li>

                        
                            
<li >
    <a href="../../examples/">Examples</a>
</li>

                        
                            
<li >
    <a href="../../middleware/">Dispatching PSR-7 Middleware</a>
</li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Migration</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../">Migration Overview</a>
</li>

        
            
<li class="active">
    <a href="./">v2.X to v2.7</a>
</li>

        
            
<li >
    <a href="../to-v3-0/">v2.X to v3.0</a>
</li>

        
    </ul>
  </li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Cookbook <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../cookbook/automating-controller-factories/">Automating controller factories</a>
</li>

                        
                            
<li >
    <a href="../../cookbook/middleware-in-listeners/">Using middleware within event listeners</a>
</li>

                        
                        </ul>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" class="component-toggle" data-toggle="tooltip" data-placement="bottom" title="Show component list">
                        <i class="fa fa-book"></i> Components
                    </a>
                </li>

                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li>
                        <a href="https://github.com/zendframework/zend-mvc">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

    <!-- content:begin -->
    <div id="page-top" class="container docs">
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#upgrading-to-27">Upgrading to 2.7</a></li>
        
    
        <li class="main "><a href="#middleware">Middleware</a></li>
        
    
        <li class="main "><a href="#application">Application</a></li>
        
    
        <li class="main "><a href="#eventmanageraware-initializers">EventManagerAware initializers</a></li>
        
    
        <li class="main "><a href="#servicelocatoraware-initializers">ServiceLocatorAware initializers</a></li>
        
            <li><a href="#optional-dependencies">Optional dependencies</a></li>
        
    
    </ul>

    
    <ul class="pager hidden-print">
      <li class="previous">
        <a rel="prev" href="../"><i class="fa fa-arrow-left"></i> Previous</a>
      </li>
      <li class="next">
        <a rel="next" href="../to-v3-0/">Next <i class="fa fa-arrow-right"></i></a>
      </li>
    </ul>
    
</div></div>
        <div class="col-md-9" role="main">

<ol class="breadcrumb" role="navigation" aria-label="breadcrumbs navigation">
  <li><a href="../..">zend-mvc</a> &raquo;</li>
  
    
      
        <li>Reference &raquo;</li>
      
    
      
        <li>Migration &raquo;</li>
      
    
  
  <li class="active">v2.X to v2.7</li>
</ol>

<h2 id="upgrading-to-27">Upgrading to 2.7</h2>
<h2 id="middleware">Middleware</h2>
<p>zend-mvc now registers <code>Zend\Mvc\MiddlewareListener</code> as a dispatch listener at
a priority higher than <code>Zend\Mvc\DispatchListener</code>, allowing dispatch of
<a href="http://www.php-fig.org/psr/psr-7/">PSR-7</a> middleware. Read the
<a href="../../middleware/">middleware chapter</a> for details on how to use this new feature.</p>
<h2 id="application">Application</h2>
<p>The constructor signature of <code>Zend\Mvc\Application</code> has changed. Previously, it
was:</p>
<pre class="codehilite"><code class="language-php linenums">__construct($configuration, ServiceManager $serviceManager)</code></pre>

<p>and internally, it pulled the services <code>EventManager</code>, <code>Request</code>, and <code>Response</code>
from the provided <code>$serviceManager</code> during initialization.</p>
<p>The new constructor signature provides optional arguments for injecting the
event manager, request, and response:</p>
<pre class="codehilite"><code class="language-php linenums">__construct(
    $configuration,
    ServiceManager $serviceManager,
    EventManager $events = null,
    RequestInterface $request = null,
    ResponseInterface $response = null
)</code></pre>

<p>This change makes all dependencies explicit. Starting in v3.0, the new arguments
will be <em>required</em>.</p>
<p>The factory <code>Zend\Mvc\Service\ApplicationFactory</code> was updated to follow the new
signature.</p>
<p>This change should only affect users who are manually instantiating the
<code>Application</code> instance.</p>
<h2 id="eventmanageraware-initializers">EventManagerAware initializers</h2>
<p>zend-mvc provides two mechanisms for injecting event managers into
<code>EventManagerAware</code> objects. One is the "EventManagerAwareInitializer"
registered in <code>Zend\Mvc\Service\ServiceManagerConfig</code>, and the other is the
<code>Zend\Mvc\Controller\ControllerManager::injectEventManager()</code> initializer. In
both cases, the logic was updated to be forwards compatible with
zend-eventmanager v3. </p>
<p>Previously each would check if the instance's <code>getEventManager()</code> method
returned an event manager instance, and, if so, inject the shared event manager:</p>
<pre class="codehilite"><code class="language-php linenums">$events = $instance-&gt;getEventManager();
if ($events instanceof EventManagerInterface) {
    $events-&gt;setSharedManager($container-&gt;get('SharedEventManager'));
}</code></pre>

<p>In zend-eventmanager v3, event managers are now injected with the shared
manager at instantiation, and no setter exists for providing the shared manager.
As such, the above logic changed to:</p>
<pre class="codehilite"><code class="language-php linenums">$events = $instance-&gt;getEventManager();
if (! $events || ! $events-&gt;getSharedManager()) {
    $instance-&gt;setEventManager($container-&gt;get('EventManager'));
}</code></pre>

<p>In other words, it re-injects with a new event manager instance if the instance
pulled does not have a shared manager composed.</p>
<p>This likely will not cause regressions in existing code, but may be something to
be aware of if you were previously depending on lazy-loaded event manager
state.</p>
<h2 id="servicelocatoraware-initializers">ServiceLocatorAware initializers</h2>
<p>zend-servicemanager v3.0 removes <code>Zend\ServiceManager\ServiceLocatorAwareInterface</code>.
Since zend-mvc provides initializers around that interface, they needed updates
to allow both forwards compatibility with zend-servicemanager v3 as well as
backwards compatibility with existing applications.</p>
<p>This was accomplished in two ways:</p>
<ul>
<li>The abstract controller implementations no longer implement
  <code>ServiceLocatorAwareInterface</code>, but continue to define the methods that the
  interface defines (namely <code>setServiceLocator()</code> and <code>getServiceLocator()</code>.</li>
<li>The initializers registered by <code>Zend\Mvc\Service\ServiceManagerConfig</code> and
  <code>Zend\Mvc\Controller\ControllerManager</code> now use duck-typing to determine if
  an instance requires container injection; if so it will do so.</li>
</ul>
<p>However, we also maintain that service locator injection is an anti-pattern;
dependencies should be injected directly into instances instead. As such,
starting in 2.7.0, we now emit a deprecation notice any time an instance is
injected by one of these initializers, and we plan to remove the initializers
for version 3.0. The deprecation notice includes the name of the class, to help
you identify what instances you will need to update before the zend-mvc v3
release.</p>
<p>To prepare your code, you will need to do the following within your controller:</p>
<ul>
<li>Find all cases where you call <code>getServiceLocator()</code>, and identify the services
  they retrieve.</li>
<li>Update your controller to accept these services via the constructor.</li>
<li>If you have not already, create a factory class for your controller.</li>
<li>In the factory, pull the appropriate services and pass them to the
  controller's constructor.</li>
</ul>
<p>As an example, consider the following code from a controller:</p>
<pre class="codehilite"><code class="language-php linenums">$db = $this-&gt;getServiceLcoator()-&gt;get('Db\ApplicationAdapter');</code></pre>

<p>To update your controller, you will:</p>
<ul>
<li>Add a <code>$db</code> property to your class.</li>
<li>Update the constructor to accept the database adapter and assign it to the
  <code>$db</code> property.</li>
<li>Change the above line to either read <code>$db = $this-&gt;db;</code> <em>or just use the
  property directly</em>.</li>
<li>Add a factory that pulls the service and pushes it into the controller.</li>
</ul>
<p>The controller then might look like the following:</p>
<pre class="codehilite"><code class="language-php linenums">use Zend\Db\Adapter\AdapterInterface;
use Zend\Mvc\Controller\AbstractActionController;

class YourController extends AbstractActionController
{
    private $db;

    public function __construct(AdapterInterface $db)
    {
        $this-&gt;db = $db;
    }

    public function someAction()
    {
        $results = $this-&gt;db-&gt;query(/* ... */);
        /* ... */
    }
}</code></pre>

<p>A factory would look like the following:</p>
<pre class="codehilite"><code class="language-php linenums">use Interop\Container\ContainerInterface;

class YourControllerFactory
{
    public function __invoke(ContainerInterface $container)
    {
        return new YourController($container-&gt;get('Db\ApplicationAdapter'));
    }
}</code></pre>

<p>You then also need to ensure the controller manager knows about the factory. It
likely already does, as an invokable; you will redefine it as a factory in
your <code>module.config.php</code>:</p>
<pre class="codehilite"><code class="language-php linenums">return [
    'controllers' =&gt; [
        'factories' =&gt; [
            YourController::class =&gt; YourControllerFactory::class,
            /* ... */
        ],
        /* ... */
    ],
    /* ... */
];</code></pre>

<p>While this may seem like more steps, doing so ensures your code has no hidden
dependencies, improves the testability of your code, and allows you to substitute
alternatives for either the dependencies or the controller itself.</p>
<h4 id="optional-dependencies">Optional dependencies</h4>
<p>In some cases, you may have dependencies that are only required for some
execution paths, such as forms, database adapters, etc. In these cases, you have
two approaches you can use:</p>
<ul>
<li>Split your controller into separate responsibilities, and use the more
  specific controllers. This way you don't need to inject dependencies that are
  only used in some actions. (We recommend doing this regardless, as it helps
  keep your code more maintainable.)</li>
<li>Use <a href="http://zendframework.github.io/zend-servicemanager/lazy-services/">lazy services</a>.
  When you configure these, zend-servicemanager gives you a proxy instance that,
  on first access, loads the full service. This allows you to delay the most
  expensive operations until absolutely needed.</li>
</ul>

<hr />


<nav>
  <ul class="pager hidden-print">
    <li class="previous">
      <a rel="prev" href="../"><i class="fa fa-arrow-left"></i> Previous</a>
    </li>
    <li class="next">
      <a rel="next" href="../to-v3-0/">Next <i class="fa fa-arrow-right"></i></a>
    </li>
  </ul>
</nav>
</div>
        
    </div>
    <!-- content:end -->

    <div id="footerwrap">
    <div class="container">
        <div class="row site-map">
            <div class="col-lg-3">
              <p>
                <strong>Zend Framework</strong><br />
                <a href="http://framework.zend.com/">framework.zend.com</a><br />
                <a href="https://docs.zendframework.com">docs.zendframework.com</a><br />
                <a href="https://packages.zendframework.com">packages.zendframework.com</a><br />
                <a href="https://apigility.org">apigility.org</a><br />
              </p>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 centered">
                <a class="back-to-top" href="#page-top"><i class="fa fa-chevron-circle-up fa-4" aria-hidden="true"></i></a>
            </div>
        </div>

        <div class="spacing"></div>

        <div class="row">
            <div class="col-lg-8">
                <h4>Copyright</h4>
                <div class="hline-w"></div>

                <p>&copy; 2006-2016 by <a href="http://www.zend.com">Zend</a>, a <a href="http://www.roguewave.com/">Rogue Wave Company</a>.</p>
            </div>

            <div class="col-lg-4">
                <h4>Contacts</h4>
                <div class="hline-w"></div>
                <p>
                    <a href="irc://irc.freenode.net/zftalk" class="btn-social btn-outline" alt="IRC" title="IRC"><i class="fa fa-comment"></i></a>
                    <a href="https://github.com/zendframework" class="btn-social btn-outline" alt="Github" title="Github"><i class="fa fa-github"></i></a>
                    <a href="https://twitter.com/zfdevteam" class="btn-social btn-outline" alt="Twitter" title="Twitter"><i class="fa fa-twitter"></i></a>
                </p>
            </div>
        </div>
    </div>
</div>


    <script src="../../js/jquery-1.10.2.min.js"></script>
    <script src="../../js/bootstrap-3.0.3.min.js"></script>
    <script src="../../js/prism-zf.js"></script>

    <script>var base_url = '../..';</script>
    <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
    <script src="../../js/base.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    <div class="zf-components">
  <div class="zf-components-grid">
    <div class="zf-logo">
      <a href="http://framework.zend.com" data-toggle="tooltip" data-placement="bottom" title="Go to the ZF homepage"><img src="../../img/zf-logo-mark.svg" alt="Zend Framework" width="250" /></a>
    </div>

    <div class="component-list"></div>

    <p class="zf-components-rollup"><a href="#">Hide list</a></p>
  </div>
</div>

    <script>
  // Prepare the component list dropdown for display
  $(function () {
    var components = $(".zf-components"),
        componentList = components.find(".component-list"),
        sidebar = $(".bs-sidebar.affix"),
        sidebarInitialPos = sidebar.css("position"),
        hidden,
        componentToggle = $(".component-toggle"),
        navbar = $(".navbar-fixed-top"),
        rollUpLink = $(".zf-components-rollup a");

    // Initial setup on document load
    components.insertBefore(navbar);
    $(".zf-logo a").tooltip();
    componentToggle.tooltip();
    rollUpLink.attr({ href: "#", alt: "Hide component list" });

    // Cast initial sidebar position value
    if (undefined === sidebarInitialPos) {
      sidebarInitialPos = "fixed";
    }

    // Setup onclick events to toggle list
    componentToggle.click(toggleComponentList);
    rollUpLink.click(toggleComponentList);

    // Toggle the component list display
    function toggleComponentList(event) {
      event.preventDefault();

      if (hidden === undefined) {
        // Not loaded yet; load and display.
        loadComponentList();
        return;
      }

      if (hidden) {
        // Hidden; display.
        showComponentList();
        return;
      }

      // Currently visible; hide
      hideComponentList();
    }

    // Show the component list
    function showComponentList() {
      navbar.css({position: "relative"});
      sidebar.css({position: "relative"});
      components
        .css({"margin-top": "-" + components.outerHeight() + "px"})
        .show()
        .animate({"margin-top": 0}, {
          complete: function () {
            componentToggle
              .data("placement", "top")
              .attr("data-original-title", "Hide component list");
            hidden = false;
          },
          queue: false
        });
    }

    // Hide the component list
    function hideComponentList() {
      components.animate({"margin-top": "-" + components.outerHeight() + "px"}, {
        complete: function () {
          navbar.css({position: "fixed"});
          sidebar.css({position: sidebarInitialPos});
          componentToggle
            .data("placement", "bottom")
            .attr("data-original-title", "Show component list");
          components.hide();
          hidden = true;
        },
        queue: false
      });
      sidebar.animate({ top: sidebarInitialTop + "px" }, { queue: false});
    }

    // Inject a component into the componet list DOM.
    function injectComponent(index, component) {
      componentList.append('<div class="component"><h4><a href="' + component.url + '">' + component.name + '</a></h4><p>' + component.description + '</p></div>');
    }

    // Parse the component list, build the DOM, and display it.
    function parseComponentList(components) {
      $.each(components, injectComponent);
      showComponentList();
    }

    // Fetch the component list and display it.
    function loadComponentList () {
      $.ajax({
        url: "//docs.zendframework.com/zf-mkdoc-theme/scripts/zf-component-list.json",
        dataType: "text json",
        success: parseComponentList,
        error: function (e) {
          console.log("Error occurred with XHR call", e);
        }
      });
    }
  });
</script>
    </body>

</html>
